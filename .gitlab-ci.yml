image: flauc/firebase

stages:
  - lint
  - deploy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - functions/node_modules/
    - client/node_modules/

before_script:
  - npm ci
  - npm --prefix client ci
  - npm --prefix functions ci

Lint Codebase:
  stage: lint
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /skip-lint/
  script:
    - npm run lint

deploy-prod:
  stage: deploy
  only:
    - master
  except:
    variables:
    - $CI_COMMIT_MESSAGE =~ /skip-build/
  script:
    - firebase use jaspero-fireshop --token $FIREBASE_TOKEN
    - npm run target-setup
    - npm run deploy -- -m "Pipe $CI_PIPELINE_ID Build $CI_BUILD_ID" --token $FIREBASE_TOKEN
